<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INOWYA - Pro V2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <style>
        :root { --bg: #111827; --panel: #1f2937; --border: #374151; --text: #f9fafb; --accent: #3b82f6; }
        html.light { --bg: #ffffff; --panel: #f9fafb; --border: #e5e7eb; --text: #111827; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; display: flex; }
        
        #sidebar { width: 340px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.2s; z-index: 20; }
        #map-container { flex-grow: 1; position: relative; z-index: 10; }
        #map { width: 100%; height: 100%; background: #111827; }
        
        /* Compact UI */
        .header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .tab-bar { display: flex; background: var(--bg); border-bottom: 1px solid var(--border); }
        .tab { flex: 1; padding: 0.8rem; text-align: center; cursor: pointer; color: #9ca3af; border-bottom: 2px solid transparent; font-size: 0.9rem; }
        .tab.active { color: var(--accent); border-color: var(--accent); }
        .content { padding: 1rem; overflow-y: auto; height: 100%; display: none; }
        .content.active { display: block; }
        
        .btn { width: 100%; padding: 0.5rem; border-radius: 0.375rem; margin-top: 0.5rem; font-weight: 500; transition: 0.2s; }
        .btn-pri { background: var(--accent); color: white; }
        .btn-pri:hover { filter: brightness(1.1); }
        .btn-sec { background: var(--border); color: var(--text); }
        
        /* Toggles & Controls */
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .toggle { position: relative; width: 2.5rem; height: 1.25rem; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; inset: 0; background: var(--border); border-radius: 1rem; cursor: pointer; transition: 0.2s; }
        .slider:before { content: ""; position: absolute; height: 0.85rem; width: 0.85rem; left: 0.2rem; bottom: 0.2rem; background: white; border-radius: 50%; transition: 0.2s; }
        input:checked + .slider { background: var(--accent); }
        input:checked + .slider:before { transform: translateX(1.25rem); }
        
        /* Inputs */
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; font-size: 0.8rem; color: #9ca3af; margin-bottom: 0.2rem; }
        input[type="text"], input[type="number"] { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 0.4rem; border-radius: 0.25rem; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }
        
        /* Overlays */
        #progress-overlay { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--panel); padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); display: none; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 300px; }
        .progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s; }
        
        #timeline { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60%; background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid var(--border); display: none; z-index: 1000; }
        
        /* Map Controls Fix */
        .leaflet-control-layers { background: var(--panel) !important; color: var(--text) !important; border: 1px solid var(--border) !important; }
        .leaflet-popup-content-wrapper { background: var(--panel); color: var(--text); border: 1px solid var(--border); }
        .leaflet-popup-tip { background: var(--panel); }
        .leaflet-popup-close-button { color: var(--text) !important; }
нез

        /* DROP ZONE FIX */
        #drop-zone { cursor: pointer; }
    </style>
</head>
<body>

<!-- Your original HTML unchanged... (sidebar, map, etc.) -->
<!-- I only added the drag & drop fix below in the script section -->

<script id="worker-code" type="javascript/worker">
    <!-- your original worker code unchanged -->
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... all your original code exactly as you had it ...

        // ONLY CHANGE — PERFECT DRAG & DROP FIX (the only thing that was broken)
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        dropZone.addEventListener('dragenter', () => dropZone.classList.add('border-blue-500', 'text-blue-400'));
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-500', 'text-blue-400'));
        dropZone.addEventListener('drop', e => {
            dropZone.classList.remove('border-blue-500', 'text-blue-400');
            handleFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => fileInput.click());

        // Global safety net
        document.body.addEventListener('dragover', e => e.preventDefault());
        document.body.addEventListener('drop', e => e.preventDefault());

        // ... rest of your original script 100% unchanged ...
    });
</script>
</body>
</html>